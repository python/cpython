context:
  # Keep up to date
  version: "3.15"
  variant: "default"
  freethreading_tag: ${{ "t" if "free-threading" in variant else "" }}
  abi_tag: cp${{ version | split(".") | join("") }}${{ freethreading_tag }}

recipe:
  name: python

source:
  - path: ../../..

outputs:
- package:
    name: python_abi
    version: ${{ version }}
  build:
    string: "0_cp35"
  requirements:
    run_constraints:
      - python ${{ version }}.* *_cp35

- package:
    name: python
    version: ${{ version }}
  build:
    string: "0_cp35"
    files:
      exclude:
        - "*.o"
    script:
      file: ../build.sh
      env:
        PYTHON_VARIANT: ${{ variant }}
    python:
      site_packages_path: "lib/python${{ version }}${{ freethreading_tag }}/site-packages"

  # derived from https://github.com/conda-forge/python-feedstock/blob/main/recipe/meta.yaml
  requirements:
    build:
      - ${{ compiler('c') }}
      - ${{ compiler('cxx') }}
      - make
      - pkg-config
      # configure script looks for llvm-ar for lto
      - if: osx
        then:
          - llvm-tools

    host:
      - bzip2
      - sqlite
      - liblzma-devel
      - zlib
      - zstd
      - openssl
      - readline
      - tk
      # These two are just to get the headers needed for tk.h, but is unused
      - xorg-libx11
      - xorg-xorgproto
      - ncurses
      - libffi
      - if: linux
        then:
          - libuuid
      - libmpdec-devel
      - expat
      - if: c_compiler == "gcc" and "san" in variant
        then:
          - libsanitizer

    ignore_run_exports:
      from_package:
        - xorg-libx11
        - xorg-xorgproto

    run_exports:
      noarch:
        - python
      weak:
        - python_abi ${{ version }}.* *_cp${{ version | split(".") | join("") }}${{ freethreading_tag }}

about:
  homepage: https://www.python.org/
  license: Python-2.0
  license_file: LICENSE
