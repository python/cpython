# -*- coding: utf-8 -*-
"""
Ù…Ø´Ø±ÙˆØ¹: ØªÙˆÙ„ÙŠØ¯ Ù…Ù„ÙØ§Øª Ø¹Ø±Ø¶ PowerPoint + PDF + ZIP
"""
import os, io, zipfile, subprocess, sys
from pptx import Presentation
from pptx.util import Inches, Pt
from pptx.enum.text import PP_ALIGN
from pptx.dml.color import RGBColor
from pptx.enum.shapes import MSO_AUTO_SHAPE_TYPE
from PIL import Image
import requests

# ---------- Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ----------
OUT_BASENAME = "Ù…Ø´Ø±ÙˆØ¹_ØµÙ†Ø§Ø¹Ø©_Ø§Ù„Ø£ÙƒÙŠØ§Ø³_Ø§Ù„Ø¨Ù„Ø§Ø³ØªÙŠÙƒÙŠØ©_ÙŠØ§Ø³ÙŠÙ†_Ø·Ø¨Ø§Ø®"
LOGO_INSFP = "insfp_logo.png"
LOGO_CDE   = "cde_logo.png"

IMAGE_URLS = [
    "https://images.unsplash.com/photo-1559056199-641a0ac8b55e?w=500",
    "https://images.unsplash.com/photo-1586023492125-27b2c045efd7?w=500",
    "https://images.unsplash.com/photo-1560472354-b33ff0c44a43?w=500",
    "https://images.unsplash.com/photo-1581235720704-06d3acfcb36f?w=500"
]

def download_images(urls, folder="images"):
    """ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙˆØ± Ù…Ø¹ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø£ÙØ¶Ù„ Ù„Ù„Ø£Ø®Ø·Ø§Ø¡"""
    os.makedirs(folder, exist_ok=True)
    local_paths = []
    for i, url in enumerate(urls, start=1):
        try:
            print(f"Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø© {i}...")
            r = requests.get(url, timeout=30)
            r.raise_for_status()
            
            fname = os.path.join(folder, f"machine_{i}.jpg")
            with open(fname, "wb") as f:
                f.write(r.content)
            local_paths.append(fname)
            print(f"âœ“ ØªÙ… ØªØ­Ù…ÙŠÙ„: {fname}")
        except Exception as e:
            print(f"âœ— ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø© {i}: {e}")
            # Ø§Ø³ØªØ®Ø¯Ø§Ù… ØµÙˆØ±Ø© Ø¨Ø¯ÙŠÙ„Ø© ÙØ§Ø±ØºØ©
            blank_img = Image.new('RGB', (800, 600), color='lightgray')
            fname = os.path.join(folder, f"machine_{i}.jpg")
            blank_img.save(fname)
            local_paths.append(fname)
    return local_paths

def create_presentation(filename, page_size_inches=(8.27, 11.69), images=[]):
    """Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„ØªÙ‚Ø¯ÙŠÙ…ÙŠ"""
    try:
        prs = Presentation()
        prs.slide_width = Inches(page_size_inches[0])
        prs.slide_height = Inches(page_size_inches[1])
        sw = prs.slide_width
        sh = prs.slide_height

        # Ø´Ø±ÙŠØ­Ø© Ø§Ù„ØºÙ„Ø§Ù
        slide = prs.slides.add_slide(prs.slide_layouts[6])
        if images:
            try:
                slide.shapes.add_picture(images[0], 0, 0, width=sw, height=sh)
            except: pass

        # Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø´Ø¹Ø§Ø±Ø§Øª Ø¥Ø°Ø§ ÙˆØ¬Ø¯Øª
        if os.path.exists(LOGO_INSFP):
            slide.shapes.add_picture(LOGO_INSFP, Inches(sw.inches - 1.6), Inches(0.35), width=Inches(1.3))
        if os.path.exists(LOGO_CDE):
            slide.shapes.add_picture(LOGO_CDE, Inches(0.35), Inches(0.35), width=Inches(1.3))

        # Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ
        tx = slide.shapes.add_textbox(Inches(0.6), Inches(1.4), sw - Inches(1.2), Inches(2))
        tf = tx.text_frame
        p = tf.paragraphs[0]
        p.text = "Ù…Ø´Ø±ÙˆØ¹ Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø¤Ø³Ø³Ø© Ù„ØµÙ†Ø§Ø¹Ø© Ø§Ù„Ø£ÙƒÙŠØ§Ø³ Ø§Ù„Ø¨Ù„Ø§Ø³ØªÙŠÙƒÙŠØ©"
        p.font.size = Pt(32)
        p.font.bold = True
        p.font.name = "Arial"
        p.alignment = PP_ALIGN.CENTER

        p2 = tf.add_paragraph()
        p2.text = "Ø¥Ø¹Ø¯Ø§Ø¯: ÙŠØ§Ø³ÙŠÙ† Ø·Ø¨Ø§Ø®\nINSFP BBA 2"
        p2.font.size = Pt(18)
        p2.font.name = "Arial"
        p2.alignment = PP_ALIGN.CENTER

        # Ø­ÙØ¸ Ø§Ù„Ù…Ù„Ù
        prs.save(filename)
        print(f"âœ“ ØªÙ… Ø¥Ù†Ø´Ø§Ø¡: {filename}")
        return True
    except Exception as e:
        print(f"âœ— Ø®Ø·Ø£ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ {filename}: {e}")
        return False

def main():
    print("ğŸš€ Ø¨Ø¯Ø¡ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹...")
    
    # ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙˆØ±
    images = download_images(IMAGE_URLS)
    
    # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø´Ø¹Ø§Ø±Ø§Øª
    if not os.path.exists(LOGO_INSFP):
        print("âš ï¸ Ù…Ù„Ø§Ø­Ø¸Ø©: Ù…Ù„Ù insfp_logo.png ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯")
    if not os.path.exists(LOGO_CDE):
        print("âš ï¸ Ù…Ù„Ø§Ø­Ø¸Ø©: Ù…Ù„Ù cde_logo.png ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯")
    
    # Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¹Ø±ÙˆØ¶
    create_presentation(f"{OUT_BASENAME}_A4.pptx", (8.27, 11.69), images)
    create_presentation(f"{OUT_BASENAME}_16-9.pptx", (13.33, 7.5), images)
    
    print("âœ… ØªÙ… Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡ Ø¨Ù†Ø¬Ø§Ø­!")
    print("ğŸ“ Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù†Ø§ØªØ¬Ø©:")
    for file in [f"{OUT_BASENAME}_A4.pptx", f"{OUT_BASENAME}_16-9.pptx"]:
        if os.path.exists(file):
            print(f"   âœ“ {file}")

if __name__ == "__main__":
    main()
